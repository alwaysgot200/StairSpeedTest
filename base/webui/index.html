<!DOCTYPE html>
<html>
  <body>
    <div id="app"></div>
    <div
      id="parse-overlay"
      style="
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 18px;
        z-index: 9999;
      "
    >
      Waiting for server running result...
    </div>
    <script>
      (function () {
        function show() {
          var el = document.getElementById("parse-overlay");
          if (el) el.style.display = "flex";
        }
        function hide() {
          var el = document.getElementById("parse-overlay");
          if (el) el.style.display = "none";
        }
        function shouldTrack(url) {
          try {
            return (
              typeof url === "string" &&
              (url.indexOf("/readsubscriptions") !== -1 ||
                url.indexOf("/readfileconfig") !== -1)
            );
          } catch (e) {
            return false;
          }
        }
        var pending = 0;
        function inc() {
          pending++;
          show();
        }
        function dec() {
          pending = Math.max(0, pending - 1);
          if (pending === 0) hide();
        }

        if (window.fetch) {
          var _fetch = window.fetch;
          window.fetch = function (input, init) {
            try {
              var url = typeof input === "string" ? input : input && input.url;
              if (shouldTrack(url)) inc();
            } catch (e) {}
            var p = _fetch.apply(this, arguments);
            return p.then(
              function (res) {
                dec();
                return res;
              },
              function (err) {
                dec();
                throw err;
              }
            );
          };
        }

        if (window.XMLHttpRequest) {
          var XO = window.XMLHttpRequest.prototype;
          var _open = XO.open,
            _send = XO.send;
          XO.open = function (method, url) {
            this._track_parse =
              shouldTrack(url) && method && method.toUpperCase() === "POST";
            return _open.apply(this, arguments);
          };
          XO.send = function () {
            if (this._track_parse) {
              inc();
              this.addEventListener("loadend", dec, { once: true });
            }
            return _send.apply(this, arguments);
          };
        }
      })();
    </script>
    <script src="manifest.js"></script>
    <script src="vendor.js"></script>
    <script src="index.js"></script>
  </body>
</html>
